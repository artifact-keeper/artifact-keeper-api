name: Generate & Publish SDKs

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Generate without publishing (dry run)"
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  id-token: write

env:
  OPENAPI_GENERATOR_VERSION: v7.12.0

jobs:
  # ─── Stage 1: Validate ───────────────────────────────────────────────
  validate:
    name: Validate OpenAPI spec
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install linters
        run: npm install -g @stoplight/spectral-cli @redocly/cli

      - name: Spectral lint
        run: spectral lint openapi.yaml --fail-severity warn

      - name: Redocly lint
        run: redocly lint openapi.yaml

      - name: Verify bundleable
        run: redocly bundle openapi.yaml -o /tmp/bundled.yaml

  # ─── Stage 1b: Parse version info ────────────────────────────────────
  version:
    name: Parse version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.parse.outputs.version }}
      pypi_version: ${{ steps.parse.outputs.pypi_version }}
      is_prerelease: ${{ steps.parse.outputs.is_prerelease }}
      npm_tag: ${{ steps.parse.outputs.npm_tag }}
    steps:
      - name: Parse tag into versions
        id: parse
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

          # Detect pre-release (contains hyphen per semver: 1.0.0-alpha.1)
          if [[ "$VERSION" == *-* ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"

            # Extract pre-release label for npm tag (alpha, beta, rc)
            LABEL=$(echo "$VERSION" | sed 's/^[0-9.]*-//' | sed 's/[.0-9]*$//')
            echo "npm_tag=${LABEL:-next}" >> "$GITHUB_OUTPUT"

            # Convert semver pre-release to PEP 440:
            #   1.0.0-alpha.1 → 1.0.0a1
            #   1.0.0-beta.2  → 1.0.0b2
            #   1.0.0-rc.1    → 1.0.0rc1
            PYPI_VERSION=$(echo "$VERSION" | sed -E 's/-alpha\.?/a/; s/-beta\.?/b/; s/-rc\.?/rc/')
            echo "pypi_version=${PYPI_VERSION}" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
            echo "npm_tag=latest" >> "$GITHUB_OUTPUT"
            echo "pypi_version=${VERSION}" >> "$GITHUB_OUTPUT"
          fi

          # Log for debugging
          echo "Version: ${VERSION}"
          echo "PyPI version: $(grep pypi_version "$GITHUB_OUTPUT" | tail -1)"
          echo "Is prerelease: $(grep is_prerelease "$GITHUB_OUTPUT" | tail -1)"
          echo "npm tag: $(grep npm_tag "$GITHUB_OUTPUT" | tail -1)"

  # ─── Stage 2: Generate all SDKs in parallel ──────────────────────────
  generate-typescript:
    name: Generate TypeScript SDK
    needs: [validate, version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        working-directory: sdk/typescript
        run: npm install

      - name: Generate SDK
        working-directory: sdk/typescript
        run: npx openapi-ts

      - name: Type-check generated code
        working-directory: sdk/typescript
        run: npx tsc --noEmit

      - name: Set package version
        working-directory: sdk/typescript
        run: npm version "${{ needs.version.outputs.version }}" --no-git-tag-version

      - name: Publish to npm
        if: ${{ !inputs.dry_run }}
        working-directory: sdk/typescript
        run: npm publish --access public --tag "${{ needs.version.outputs.npm_tag }}" --provenance

      - name: Package artifact
        run: |
          cd sdk/typescript
          zip -r "$GITHUB_WORKSPACE/artifact-keeper-ts-${{ github.ref_name }}.zip" \
            src/ package.json tsconfig.json

      - uses: actions/upload-artifact@v4
        with:
          name: sdk-typescript
          path: artifact-keeper-ts-${{ github.ref_name }}.zip

  generate-kotlin:
    name: Generate Kotlin SDK
    needs: [validate, version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Generate SDK
        uses: docker://openapitools/openapi-generator-cli:v7.12.0
        with:
          args: generate -c /github/workspace/sdk/kotlin/openapi-generator-config.yaml

      - name: Fix permissions
        run: sudo chown -R "$USER" sdk/kotlin/generated && chmod +x sdk/kotlin/generated/gradlew

      - name: Inject GitHub Packages publishing
        working-directory: sdk/kotlin/generated
        run: |
          cat >> build.gradle <<'GRADLE'

          apply plugin: 'maven-publish'

          publishing {
              publications {
                  maven(MavenPublication) {
                      groupId = 'com.artifactkeeper'
                      artifactId = 'client'
                      version = System.getenv('SDK_VERSION') ?: project.version
                      from components.java
                  }
              }
              repositories {
                  maven {
                      name = "GitHubPackages"
                      url = uri("https://maven.pkg.github.com/artifact-keeper/artifact-keeper-api")
                      credentials {
                          username = System.getenv("GITHUB_ACTOR") ?: ""
                          password = System.getenv("GITHUB_TOKEN") ?: ""
                      }
                  }
              }
          }
          GRADLE

      - name: Build and publish to GitHub Packages
        if: ${{ !inputs.dry_run }}
        working-directory: sdk/kotlin/generated
        run: ./gradlew build publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SDK_VERSION: ${{ needs.version.outputs.version }}

      - name: Package artifact
        run: cd sdk/kotlin/generated && zip -r "$GITHUB_WORKSPACE/artifact-keeper-kotlin-${{ github.ref_name }}.zip" .

      - uses: actions/upload-artifact@v4
        with:
          name: sdk-kotlin
          path: artifact-keeper-kotlin-${{ github.ref_name }}.zip

  generate-swift:
    name: Generate Swift SDK
    needs: [validate, version]
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Copy spec into package
        run: cp openapi.yaml sdk/swift/Sources/ArtifactKeeperClient/openapi.yaml

      - name: Resolve dependencies
        working-directory: sdk/swift
        run: swift package resolve

      - name: Build package
        working-directory: sdk/swift
        run: swift build

      - name: Push to SPM repo
        if: ${{ !inputs.dry_run }}
        env:
          DEPLOY_KEY: ${{ secrets.SWIFT_SDK_DEPLOY_KEY }}
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          # Set up SSH deploy key
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/swift-sdk-deploy
          chmod 600 ~/.ssh/swift-sdk-deploy
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          export GIT_SSH_COMMAND="ssh -i ~/.ssh/swift-sdk-deploy -o IdentitiesOnly=yes"
          git clone git@github.com:artifact-keeper/artifact-keeper-swift-sdk.git /tmp/swift-sdk
          # Clear old contents (keep .git)
          find /tmp/swift-sdk -maxdepth 1 ! -name '.git' ! -path /tmp/swift-sdk -exec rm -rf {} +
          # Copy package contents + CI + metadata
          cp sdk/swift/Package.swift /tmp/swift-sdk/
          cp sdk/swift/LICENSE /tmp/swift-sdk/
          cp sdk/swift/README.md /tmp/swift-sdk/
          cp -R sdk/swift/Sources /tmp/swift-sdk/
          cp -R sdk/swift/.github /tmp/swift-sdk/
          cd /tmp/swift-sdk
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update Swift SDK to ${VERSION}" || echo "No changes to commit"
          git tag "v${VERSION}"
          git push origin main --tags
          # Clean up key
          rm -f ~/.ssh/swift-sdk-deploy

      - name: Package artifact
        run: |
          cd sdk/swift
          zip -r "$GITHUB_WORKSPACE/artifact-keeper-swift-${{ github.ref_name }}.zip" \
            Package.swift Sources/

      - uses: actions/upload-artifact@v4
        with:
          name: sdk-swift
          path: artifact-keeper-swift-${{ github.ref_name }}.zip

  generate-rust:
    name: Generate Rust SDK
    needs: [validate, version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate SDK
        uses: docker://openapitools/openapi-generator-cli:v7.12.0
        with:
          args: >-
            generate
            -i openapi.yaml
            -g rust
            -o generated/rust
            --additional-properties=packageName=artifact-keeper-client,packageVersion=${{ needs.version.outputs.version }},library=reqwest,supportMultipart=true
            --type-mappings=file=Vec<u8>

      - name: Fix permissions
        run: sudo chown -R "$USER" generated/rust

      - name: Inject crate metadata
        working-directory: generated/rust
        run: |
          # Replace the generated description and add missing crates.io fields
          sed -i 's|^description = .*|description = "Rust client for the Artifact Keeper REST API"|' Cargo.toml
          # Add license/repo/homepage after the description line (only if not already present)
          grep -q '^license' Cargo.toml || sed -i '/^description = /a\license = "MIT"' Cargo.toml
          grep -q '^repository' Cargo.toml || sed -i '/^license/a\repository = "https://github.com/artifact-keeper/artifact-keeper-api"' Cargo.toml
          grep -q '^homepage' Cargo.toml || sed -i '/^repository/a\homepage = "https://github.com/artifact-keeper/artifact-keeper-api"' Cargo.toml

      - uses: dtolnay/rust-toolchain@stable

      - name: Build generated code
        working-directory: generated/rust
        run: cargo check

      - name: Publish to crates.io
        if: ${{ !inputs.dry_run }}
        working-directory: generated/rust
        run: cargo publish --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Package artifact
        run: cd generated/rust && zip -r "$GITHUB_WORKSPACE/artifact-keeper-rust-${{ github.ref_name }}.zip" .

      - uses: actions/upload-artifact@v4
        with:
          name: sdk-rust
          path: artifact-keeper-rust-${{ github.ref_name }}.zip

  generate-python:
    name: Generate Python SDK
    needs: [validate, version]
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - uses: actions/checkout@v4

      - name: Generate SDK
        uses: docker://openapitools/openapi-generator-cli:v7.12.0
        with:
          args: >-
            generate
            -c /github/workspace/sdk/python/openapi-generator-config.yaml
            --additional-properties=packageVersion=${{ needs.version.outputs.pypi_version }}

      - name: Fix permissions
        run: sudo chown -R "$USER" sdk/python/generated

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Inject package metadata
        working-directory: sdk/python/generated
        run: |
          # Ensure setup.py has our metadata
          if [ -f setup.py ]; then
            sed -i 's|url=.*|url="https://github.com/artifact-keeper/artifact-keeper-api",|' setup.py
            sed -i 's|license=.*|license="MIT",|' setup.py
          fi

      - name: Install and verify
        working-directory: sdk/python/generated
        run: |
          pip install build
          pip install .
          python -c "import artifact_keeper_client; print('OK')"

      - name: Build distribution
        working-directory: sdk/python/generated
        run: python -m build

      - name: Publish to PyPI
        if: ${{ !inputs.dry_run }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: sdk/python/generated/dist/

      - name: Package artifact
        run: cd sdk/python/generated && zip -r "$GITHUB_WORKSPACE/artifact-keeper-python-${{ github.ref_name }}.zip" .

      - uses: actions/upload-artifact@v4
        with:
          name: sdk-python
          path: artifact-keeper-python-${{ github.ref_name }}.zip

  # ─── Stage 3: Create GitHub Release ──────────────────────────────────
  release:
    name: Create GitHub Release
    needs: [generate-typescript, generate-kotlin, generate-swift, generate-rust, generate-python, version]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          prerelease: ${{ needs.version.outputs.is_prerelease == 'true' }}
          files: |
            openapi.yaml
            artifacts/artifact-keeper-ts-${{ github.ref_name }}.zip
            artifacts/artifact-keeper-kotlin-${{ github.ref_name }}.zip
            artifacts/artifact-keeper-swift-${{ github.ref_name }}.zip
            artifacts/artifact-keeper-rust-${{ github.ref_name }}.zip
            artifacts/artifact-keeper-python-${{ github.ref_name }}.zip
          body: |
            ## Artifact Keeper API ${{ github.ref_name }}

            ### Install

            **TypeScript** (npm):
            ```
            npm install @artifact-keeper/sdk@${{ needs.version.outputs.version }}
            ```

            **Python** (PyPI):
            ```
            pip install artifact-keeper-client==${{ needs.version.outputs.version }}
            ```

            **Kotlin** (Gradle — GitHub Packages Maven):
            ```kotlin
            repositories {
                maven { url = uri("https://maven.pkg.github.com/artifact-keeper/artifact-keeper-api") }
            }
            dependencies {
                implementation("com.artifactkeeper:client:${{ needs.version.outputs.version }}")
            }
            ```

            **Rust** (crates.io):
            ```toml
            [dependencies]
            artifact-keeper-client = "${{ needs.version.outputs.version }}"
            ```

            **Swift** (SPM):
            ```swift
            .package(url: "https://github.com/artifact-keeper/artifact-keeper-swift-sdk.git", from: "${{ needs.version.outputs.version }}")
            ```

            ### Release artifacts
            | File | Description |
            |------|-------------|
            | `openapi.yaml` | OpenAPI 3.1 spec |
            | `artifact-keeper-ts-*.zip` | TypeScript client (fetch) |
            | `artifact-keeper-kotlin-*.zip` | Kotlin client (Retrofit + kotlinx.serialization) |
            | `artifact-keeper-swift-*.zip` | Swift SPM package (URLSession) |
            | `artifact-keeper-rust-*.zip` | Rust client (reqwest) |
            | `artifact-keeper-python-*.zip` | Python client (urllib3) |
