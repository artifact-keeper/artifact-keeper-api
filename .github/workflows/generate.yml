name: Generate & Publish SDKs

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Generate without publishing (dry run)"
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  id-token: write

env:
  OPENAPI_GENERATOR_VERSION: v7.12.0

jobs:
  # ─── Stage 1: Validate ───────────────────────────────────────────────
  validate:
    name: Validate OpenAPI spec
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install linters
        run: npm install -g @stoplight/spectral-cli @redocly/cli

      - name: Spectral lint
        run: spectral lint openapi.yaml --fail-severity warn

      - name: Redocly lint
        run: redocly lint openapi.yaml

      - name: Verify bundleable
        run: redocly bundle openapi.yaml -o /tmp/bundled.yaml

  # ─── Stage 2: Generate all SDKs in parallel ──────────────────────────
  generate-typescript:
    name: Generate TypeScript SDK
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Install dependencies
        working-directory: sdk/typescript
        run: npm install

      - name: Generate SDK
        working-directory: sdk/typescript
        run: npx openapi-ts

      - name: Type-check generated code
        working-directory: sdk/typescript
        run: npx tsc --noEmit

      - name: Set package version
        working-directory: sdk/typescript
        run: npm version "${{ steps.version.outputs.version }}" --no-git-tag-version

      - name: Publish to npm
        if: ${{ !inputs.dry_run }}
        working-directory: sdk/typescript
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Package artifact
        run: |
          cd sdk/typescript
          zip -r "$GITHUB_WORKSPACE/artifact-keeper-ts-${{ github.ref_name }}.zip" \
            src/ package.json tsconfig.json

      - uses: actions/upload-artifact@v4
        with:
          name: sdk-typescript
          path: artifact-keeper-ts-${{ github.ref_name }}.zip

  generate-kotlin:
    name: Generate Kotlin SDK
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Generate SDK
        uses: docker://openapitools/openapi-generator-cli:v7.12.0
        with:
          args: generate -c /github/workspace/sdk/kotlin/openapi-generator-config.yaml

      - name: Fix permissions
        run: sudo chown -R "$USER" sdk/kotlin/generated && chmod +x sdk/kotlin/generated/gradlew

      - name: Inject GitHub Packages publishing
        working-directory: sdk/kotlin/generated
        run: |
          cat >> build.gradle <<'GRADLE'

          apply plugin: 'maven-publish'

          publishing {
              publications {
                  maven(MavenPublication) {
                      groupId = 'com.artifactkeeper'
                      artifactId = 'client'
                      version = System.getenv('SDK_VERSION') ?: project.version
                      from components.java
                  }
              }
              repositories {
                  maven {
                      name = "GitHubPackages"
                      url = uri("https://maven.pkg.github.com/artifact-keeper/artifact-keeper-api")
                      credentials {
                          username = System.getenv("GITHUB_ACTOR") ?: ""
                          password = System.getenv("GITHUB_TOKEN") ?: ""
                      }
                  }
              }
          }
          GRADLE

      - name: Build and publish to GitHub Packages
        if: ${{ !inputs.dry_run }}
        working-directory: sdk/kotlin/generated
        run: ./gradlew build publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SDK_VERSION: ${{ steps.version.outputs.version }}

      - name: Package artifact
        run: cd sdk/kotlin/generated && zip -r "$GITHUB_WORKSPACE/artifact-keeper-kotlin-${{ github.ref_name }}.zip" .

      - uses: actions/upload-artifact@v4
        with:
          name: sdk-kotlin
          path: artifact-keeper-kotlin-${{ github.ref_name }}.zip

  generate-swift:
    name: Generate Swift SDK
    needs: validate
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Copy spec into package
        run: cp openapi.yaml sdk/swift/Sources/ArtifactKeeperClient/openapi.yaml

      - name: Resolve dependencies
        working-directory: sdk/swift
        run: swift package resolve

      - name: Build package
        working-directory: sdk/swift
        run: swift build

      - name: Publish to SPM repo
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ github.ref_name }}"
          REPO="artifact-keeper/artifact-keeper-swift-sdk"

          # Clone or init the target repo
          gh repo clone "$REPO" spm-repo 2>/dev/null || {
            mkdir spm-repo && cd spm-repo && git init
            git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"
            cd ..
          }

          # Clear and copy SDK contents
          cd spm-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          find . -not -path './.git/*' -not -path './.git' -not -path '.' -delete
          cp -r ../sdk/swift/Package.swift .
          cp -r ../sdk/swift/Sources .

          # Commit and tag
          git add -A
          git commit -m "Release ${TAG}" || echo "No changes to commit"
          git tag -f "$TAG"
          git push origin HEAD:main --force
          git push origin "$TAG" --force

      - name: Package artifact
        run: |
          cd sdk/swift
          zip -r "$GITHUB_WORKSPACE/artifact-keeper-swift-${{ github.ref_name }}.zip" \
            Package.swift Sources/

      - uses: actions/upload-artifact@v4
        with:
          name: sdk-swift
          path: artifact-keeper-swift-${{ github.ref_name }}.zip

  generate-rust:
    name: Generate Rust SDK
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Generate SDK
        uses: docker://openapitools/openapi-generator-cli:v7.12.0
        with:
          args: >-
            generate
            -i openapi.yaml
            -g rust
            -o generated/rust
            --additional-properties=packageName=artifact-keeper-client,packageVersion=${{ steps.version.outputs.version }},library=reqwest,supportMultipart=true
            --type-mappings=file=Vec<u8>

      - name: Fix permissions
        run: sudo chown -R "$USER" generated/rust

      - name: Inject crate metadata
        working-directory: generated/rust
        run: |
          # Add required crates.io fields into the existing [package] section
          sed -i '/^version = /a\
          license = "MIT"\
          description = "Rust client for the Artifact Keeper REST API"\
          repository = "https://github.com/artifact-keeper/artifact-keeper-api"\
          homepage = "https://github.com/artifact-keeper/artifact-keeper-api"' Cargo.toml

      - uses: dtolnay/rust-toolchain@stable

      - name: Build generated code
        working-directory: generated/rust
        run: cargo check

      - name: Publish to crates.io
        if: ${{ !inputs.dry_run }}
        working-directory: generated/rust
        run: cargo publish --allow-dirty
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Package artifact
        run: cd generated/rust && zip -r "$GITHUB_WORKSPACE/artifact-keeper-rust-${{ github.ref_name }}.zip" .

      - uses: actions/upload-artifact@v4
        with:
          name: sdk-rust
          path: artifact-keeper-rust-${{ github.ref_name }}.zip

  generate-python:
    name: Generate Python SDK
    needs: validate
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Generate SDK
        uses: docker://openapitools/openapi-generator-cli:v7.12.0
        with:
          args: >-
            generate
            -c /github/workspace/sdk/python/openapi-generator-config.yaml
            --additional-properties=packageVersion=${{ steps.version.outputs.version }}

      - name: Fix permissions
        run: sudo chown -R "$USER" sdk/python/generated

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Inject package metadata
        working-directory: sdk/python/generated
        run: |
          # Ensure setup.py has our metadata
          if [ -f setup.py ]; then
            sed -i 's|url=.*|url="https://github.com/artifact-keeper/artifact-keeper-api",|' setup.py
            sed -i 's|license=.*|license="MIT",|' setup.py
          fi

      - name: Install and verify
        working-directory: sdk/python/generated
        run: |
          pip install build
          pip install .
          python -c "import artifact_keeper_client; print('OK')"

      - name: Build distribution
        working-directory: sdk/python/generated
        run: python -m build

      - name: Publish to PyPI
        if: ${{ !inputs.dry_run }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: sdk/python/generated/dist/

      - name: Package artifact
        run: cd sdk/python/generated && zip -r "$GITHUB_WORKSPACE/artifact-keeper-python-${{ github.ref_name }}.zip" .

      - uses: actions/upload-artifact@v4
        with:
          name: sdk-python
          path: artifact-keeper-python-${{ github.ref_name }}.zip

  # ─── Stage 3: Create GitHub Release ──────────────────────────────────
  release:
    name: Create GitHub Release
    needs: [generate-typescript, generate-kotlin, generate-swift, generate-rust, generate-python]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            openapi.yaml
            artifacts/artifact-keeper-ts-${{ github.ref_name }}.zip
            artifacts/artifact-keeper-kotlin-${{ github.ref_name }}.zip
            artifacts/artifact-keeper-swift-${{ github.ref_name }}.zip
            artifacts/artifact-keeper-rust-${{ github.ref_name }}.zip
            artifacts/artifact-keeper-python-${{ github.ref_name }}.zip
          body: |
            ## Artifact Keeper API ${{ github.ref_name }}

            ### Install

            **TypeScript** (npm):
            ```
            npm install @artifact-keeper/sdk@${{ steps.version.outputs.version }}
            ```

            **Python** (PyPI):
            ```
            pip install artifact-keeper-client==${{ steps.version.outputs.version }}
            ```

            **Kotlin** (Gradle — GitHub Packages Maven):
            ```kotlin
            repositories {
                maven { url = uri("https://maven.pkg.github.com/artifact-keeper/artifact-keeper-api") }
            }
            dependencies {
                implementation("com.artifactkeeper:client:${{ steps.version.outputs.version }}")
            }
            ```

            **Rust** (crates.io):
            ```toml
            [dependencies]
            artifact-keeper-client = "${{ steps.version.outputs.version }}"
            ```

            **Swift** (SPM):
            ```swift
            .package(url: "https://github.com/artifact-keeper/artifact-keeper-swift-sdk.git", from: "${{ steps.version.outputs.version }}")
            ```

            ### Release artifacts
            | File | Description |
            |------|-------------|
            | `openapi.yaml` | OpenAPI 3.1 spec |
            | `artifact-keeper-ts-*.zip` | TypeScript client (fetch) |
            | `artifact-keeper-kotlin-*.zip` | Kotlin client (Retrofit + kotlinx.serialization) |
            | `artifact-keeper-swift-*.zip` | Swift SPM package (URLSession) |
            | `artifact-keeper-rust-*.zip` | Rust client (reqwest) |
            | `artifact-keeper-python-*.zip` | Python client (urllib3) |
